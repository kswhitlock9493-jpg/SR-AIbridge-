name: Bridge Auto-Deploy Mode

on:
  push:
    branches: [ "main" ]
  schedule:
    - cron: "0 */6 * * *"   # Every 6 hours
  workflow_dispatch:

jobs:
  bridge-autodeploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: bridge-frontend/package-lock.json

      - name: Install Chrome Dependencies
        run: |
          # Install Playwright browser dependencies
          npx playwright install-deps
          npx playwright install chromium

      - name: Install Dependencies
        run: |
          cd bridge-frontend
          npm ci --legacy-peer-deps || npm install --legacy-peer-deps

      - name: Build Frontend
        run: |
          cd bridge-frontend
          npm run build

      - name: Setup Forge Dominion
        id: forge
        uses: ./.github/actions/forge-dominion-setup
        with:
          forge-dominion-root: ${{ secrets.FORGE_DOMINION_ROOT }}
          providers: 'netlify'

      - name: Notify Deployment Start
        run: |
          python3 bridge_backend/utils/deployment_publisher.py \
            --platform netlify \
            --event-type start \
            --status deploying \
            --branch main \
            --message "Auto-deploy via Bridge Auto-Deploy Mode v1.9.7s (Forge Dominion)" || echo "‚ö†Ô∏è Event notification skipped"

      - name: Verify Backend Health
        timeout-minutes: 5
        run: |
          echo "üîç Verifying backend health..."
          response=$(curl -f -s https://sr-aibridge.onrender.com/api/health || echo "FAILED")
          if [[ "$response" == "FAILED" ]]; then
            echo "‚ùå Backend health check failed"
            exit 1
          fi
          echo "‚úÖ Backend is healthy"

      - name: Generate Sync Badge
        run: |
          python3 bridge_backend/scripts/generate_sync_badge.py

      - name: Deploy to Netlify (Forge Dominion)
        env:
          NETLIFY_AUTH_TOKEN: ${{ steps.forge.outputs.netlify-token }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        run: |
          npm install -g netlify-cli
          cd bridge-frontend
          echo "üúÇ Deploying with Forge Dominion ephemeral token..."
          netlify deploy --prod --dir=dist --message="Auto-redeploy via Bridge Auto-Deploy Mode v1.9.7s (Sovereign)"

      - name: Notify Deployment Success
        if: success()
        run: |
          python3 bridge_backend/utils/deployment_publisher.py \
            --platform netlify \
            --event-type success \
            --status deployed \
            --branch main \
            --deploy-url "https://sr-aibridge.netlify.app" \
            --message "Deployment successful (Forge Dominion)" || echo "‚ö†Ô∏è Event notification skipped"

      - name: Notify Deployment Failure
        if: failure()
        run: |
          python3 bridge_backend/utils/deployment_publisher.py \
            --platform netlify \
            --event-type failure \
            --status failed \
            --branch main \
            --message "Deployment failed" || echo "‚ö†Ô∏è Event notification skipped"

      - name: Report to Diagnostics
        run: |
          python3 bridge_backend/scripts/report_bridge_event.py --status AUTODEPLOY_OK || echo "‚ö†Ô∏è Diagnostics reporting skipped"

      - name: Deployment Summary
        run: |
          echo "=== Bridge Auto-Deploy Summary (Forge Dominion) ==="
          echo "‚úÖ Frontend built successfully"
          echo "‚úÖ Backend health verified"
          echo "‚úÖ Sync badge updated"
          echo "üúÇ Forge Dominion: ${{ steps.forge.outputs.tokens-minted }} tokens minted"
          echo "‚úÖ Deployed to Netlify (ephemeral token)"
          echo "==================================================="

