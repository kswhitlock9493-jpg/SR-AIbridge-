name: Bridge Autonomy Healer

on:
  workflow_run:
    workflows: ["Build & Deploy"]
    types:
      - completed
  workflow_dispatch:

jobs:
  heal:
    runs-on: ubuntu-latest
    if: ${{ failure() || github.event.workflow_run.conclusion == 'failure' }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Trigger Bridge Autonomy
        run: |
          if [ -n "${{ vars.PUBLIC_API_BASE }}" ] && [ -n "${{ secrets.AUTONOMY_API_TOKEN }}" ]; then
            curl -X POST "${{ vars.PUBLIC_API_BASE }}/api/autonomy/incident" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer ${{ secrets.AUTONOMY_API_TOKEN }}" \
              -d '{
                "kind": "deploy.failure",
                "source": "github",
                "details": {
                  "workflow": "build-deploy",
                  "run_id": "${{ github.run_id }}",
                  "repository": "${{ github.repository }}"
                }
              }'
          else
            echo "⚠️ Autonomy not configured - missing PUBLIC_API_BASE or AUTONOMY_API_TOKEN"
          fi
