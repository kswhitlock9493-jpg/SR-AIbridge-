name: Build Triage (Netlify)
on:
  workflow_dispatch:
  schedule: [ { cron: "15 */6 * * *" } ]
permissions: { contents: read }
jobs:
  build-triage:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: 
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: 'bridge-frontend/package-lock.json'

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('bridge-frontend/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Install Chrome Dependencies
        run: |
          # Install system dependencies for Playwright only (skip browser downloads)
          npx playwright install-deps
        env:
          PUPPETEER_SKIP_DOWNLOAD: "true"
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: "true"
          PUPPETEER_SKIP_CHROMIUM_DOWNLOAD: "true"

      - name: Install & Dry Build (monorepo aware)
        env:
          CI: false
          PUPPETEER_SKIP_DOWNLOAD: "true"
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: "true"
          PUPPETEER_SKIP_CHROMIUM_DOWNLOAD: "true"
        run: |
          cd bridge-frontend
          npm ci || npm install
          npm run build --if-present || echo "::warning ::build script missing"
          test -d dist || echo "::error ::No dist folder created"

      - name: Emit Build Artifact Summary
        run: |
          python3 - <<'PY'
          import json, os, pathlib
          out = {
            "has_dist": os.path.isdir("bridge-frontend/dist"),
            "size_kb": sum((f.stat().st_size for f in pathlib.Path("bridge-frontend/dist").rglob("*") if f.is_file()), 0)//1024 if os.path.isdir("bridge-frontend/dist") else 0,
            "missing_scripts": not (pathlib.Path("bridge-frontend/package.json").read_text().find('"build"')>0)
          }
          pathlib.Path("bridge_backend/diagnostics").mkdir(parents=True, exist_ok=True)
          (pathlib.Path("bridge_backend/diagnostics")/"build_triage_report.json").write_text(json.dumps(out, indent=2))
          print(json.dumps(out, indent=2))
          PY
      - uses: actions/upload-artifact@v4
        with:
          name: build_triage_report
          path: bridge_backend/diagnostics/build_triage_report.json
