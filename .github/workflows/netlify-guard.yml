name: Netlify Config Guard
on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  guard:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Synthesize artifacts
        run: |
          python3 -m pip install --upgrade pip
          python3 scripts/synthesize_netlify_artifacts.py
      
      - name: Validate netlify.toml presence and syntax
        run: |
          test -f netlify.toml || { echo "❌ netlify.toml missing"; exit 1; }
          echo "✅ netlify.toml exists"
      
      - name: Validate artifacts created
        run: |
          test -f public/_headers || { echo "❌ _headers missing"; exit 1; }
          test -f public/_redirects || { echo "❌ _redirects missing"; exit 1; }
          test -f dist/index.html || { echo "❌ index.html missing"; exit 1; }
          echo "✅ All required artifacts exist"
      
      - name: Build (no-op safe)
        run: |
          if [ -f "scripts/netlify_build.sh" ]; then
            bash scripts/netlify_build.sh
          else
            echo "⚠️  netlify_build.sh not found, skipping"
          fi
