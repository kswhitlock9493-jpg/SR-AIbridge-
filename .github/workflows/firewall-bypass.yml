name: Browser Dependency Resolution (Firewall Bypass)

on:
  workflow_call:
    inputs:
      skip-chromium:
        description: 'Skip Chromium installation'
        required: false
        type: boolean
        default: false
      node-version:
        description: 'Node.js version to use'
        required: false
        type: string
        default: '20'

jobs:
  resolve-browser-deps:
    name: Resolve Browser Dependencies
    runs-on: ubuntu-latest
    
    steps:
      - name: Configure Alternative Browser Sources
        if: ${{ !inputs.skip-chromium }}
        run: |
          echo "üåê Configuring browser dependencies for firewall-restricted environment..."
          
          # Install Playwright system dependencies
          echo "üì¶ Installing Playwright browser dependencies..."
          npx playwright install-deps || echo "‚ö†Ô∏è Playwright deps install failed, continuing..."
          
          # Install Chromium via Playwright (bypasses firewall restrictions)
          echo "üîß Installing Chromium browser..."
          npx playwright install chromium || echo "‚ö†Ô∏è Chromium install failed, continuing..."
          
          # Set browser executable path for tools that need it
          CHROMIUM_PATH=$(which chromium 2>/dev/null || which chromium-browser 2>/dev/null || echo "")
          if [ -n "$CHROMIUM_PATH" ]; then
            echo "BROWSER_EXECUTABLE_PATH=$CHROMIUM_PATH" >> $GITHUB_ENV
            echo "‚úÖ Browser executable found at: $CHROMIUM_PATH"
          else
            echo "‚ö†Ô∏è Chromium not found in PATH, tools may use system default"
          fi
      
      - name: Set Puppeteer Environment Variables
        run: |
          echo "üîß Configuring Puppeteer to skip download..."
          echo "PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true" >> $GITHUB_ENV
          echo "PUPPETEER_SKIP_DOWNLOAD=true" >> $GITHUB_ENV
          
          # Try to find Chrome/Chromium for Puppeteer
          CHROME_PATH=$(which chromium 2>/dev/null || which chromium-browser 2>/dev/null || which google-chrome 2>/dev/null || echo "")
          if [ -n "$CHROME_PATH" ]; then
            echo "CHROME_BIN=$CHROME_PATH" >> $GITHUB_ENV
            echo "PUPPETEER_EXECUTABLE_PATH=$CHROME_PATH" >> $GITHUB_ENV
            echo "‚úÖ Chrome/Chromium configured for Puppeteer: $CHROME_PATH"
          else
            echo "‚ö†Ô∏è Chrome/Chromium not found, Puppeteer may fail if required"
          fi
      
      - name: Set Playwright Environment Variables
        run: |
          echo "üîß Configuring Playwright..."
          echo "PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD=false" >> $GITHUB_ENV
          echo "PLAYWRIGHT_BROWSERS_PATH=0" >> $GITHUB_ENV
          echo "‚úÖ Playwright configured to use system browsers"
      
      - name: Verify Browser Installation
        if: ${{ !inputs.skip-chromium }}
        run: |
          echo "üîç Verifying browser installation..."
          
          # Check if Chromium is available
          if command -v chromium &> /dev/null || command -v chromium-browser &> /dev/null; then
            CHROMIUM_VERSION=$(chromium --version 2>/dev/null || chromium-browser --version 2>/dev/null || echo "Unknown")
            echo "‚úÖ Chromium installed: $CHROMIUM_VERSION"
          else
            echo "‚ö†Ô∏è Chromium not found in system PATH"
          fi
          
          # Check Playwright browsers
          if npx playwright --version &> /dev/null; then
            PLAYWRIGHT_VERSION=$(npx playwright --version 2>/dev/null || echo "Unknown")
            echo "‚úÖ Playwright available: $PLAYWRIGHT_VERSION"
          else
            echo "‚ö†Ô∏è Playwright not available"
          fi
          
          echo "‚úÖ Browser dependency resolution complete"
