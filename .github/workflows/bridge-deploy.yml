name: üåâ Bridge Deploy
on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      FORGE_DOMINION_ROOT: ${{ secrets.FORGE_DOMINION_ROOT }}
      DOMINION_SEAL: ${{ secrets.DOMINION_SEAL }}
      NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
      NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Frontend Dependencies
        run: |
          cd bridge-frontend
          npm ci

      - name: Build Bridge Frontend
        run: |
          cd bridge-frontend
          npm run build

      - name: Export Forge Runtime
        run: |
          python3 bridge_backend/forge/export_runtime.py

      - name: Deploy to Netlify
        uses: nwtgck/actions-netlify@v2
        with:
          publish-dir: bridge-frontend/dist
          production-deploy: true
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: "üõ∞Ô∏è Sovereign Bridge: Automatic Deploy from Forge Dominion"
          enable-pull-request-comment: false
          enable-commit-comment: false
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

      - name: Notify Forge Dominion
        run: |
          curl -X POST "https://sovereign.bridge/api/forge/deploy" \
          -H "Authorization: Bearer $DOMINION_SEAL" \
          -H "Content-Type: application/json" \
          -d '{"status": "deployed", "env": "${{ github.ref_name }}", "build_id": "${{ github.run_id }}"}' \
          || echo "Warning: Failed to notify Forge Dominion endpoint"
