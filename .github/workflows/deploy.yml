name: Build & Deploy SR-AIbridge

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch: {}

jobs:
  # Predictive deployment with Chimera Oracle (v1.9.7i)
  predictive-deploy:
    name: Predictive Deploy Pipeline
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Install backend deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Predictive pipeline (simulate → certify → deploy with fallback)
        env:
          ENGINES_ENABLE_TRUE: "true"
          RBAC_ENFORCED: "true"
          TRUTH_CERTIFICATION: "true"
          GENESIS_MODE: "enabled"
        run: |
          python -m bridge_backend.cli.deployctl predictive --ref $GITHUB_SHA
      
      - name: Upload Hydra artifacts (headers/redirects)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: hydra-artifacts
          path: |
            public/_headers
            public/_redirects
            netlify.toml

  # Frontend deployment to Netlify
  deploy-frontend:
    name: Deploy Frontend to Netlify
    runs-on: ubuntu-latest
    needs: [predictive-deploy]
    if: success() || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: bridge-frontend/package-lock.json

      - name: Install Chrome Dependencies
        run: |
          # Use GitHub's built-in browser tools
          npx playwright install-deps
          npx playwright install chromium

      - name: Install dependencies
        run: cd bridge-frontend && npm ci

      - name: Build frontend
        run: cd bridge-frontend && npm run build
        env:
          CI: false
          REACT_APP_API_URL: >-
            ${{ secrets.BACKEND_URL ||
            'https://sr-aibridge-backend.onrender.com' }}

      - name: Notify Netlify Deployment Start
        run: |
          python3 bridge_backend/utils/deployment_publisher.py \
            --platform netlify \
            --event-type start \
            --status deploying \
            --branch ${{ github.ref_name }} \
            --commit-sha ${{ github.sha }} \
            --message "Deploy from GitHub Actions" || echo "⚠️ Event notification skipped"

      - name: Deploy to Netlify
        uses: nwtgck/actions-netlify@v3.0
        with:
          publish-dir: './bridge-frontend/dist'
          production-branch: main
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: "Deploy from GitHub Actions"
          enable-pull-request-comment: true
          enable-commit-comment: true
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        timeout-minutes: 10

      - name: Notify Netlify Deployment Success
        if: success()
        run: |
          python3 bridge_backend/utils/deployment_publisher.py \
            --platform netlify \
            --event-type success \
            --status deployed \
            --branch ${{ github.ref_name }} \
            --commit-sha ${{ github.sha }} \
            --deploy-url "https://sr-aibridge.netlify.app" \
            --message "Deployment successful" || echo "⚠️ Event notification skipped"

      - name: Notify Netlify Deployment Failure
        if: failure()
        run: |
          python3 bridge_backend/utils/deployment_publisher.py \
            --platform netlify \
            --event-type failure \
            --status failed \
            --branch ${{ github.ref_name }} \
            --commit-sha ${{ github.sha }} \
            --message "Deployment failed" || echo "⚠️ Event notification skipped"

      - name: Notify Bridge Diagnostics
        if: success() && github.ref == 'refs/heads/main'
        run: |
          BRIDGE_URL="${{ secrets.BRIDGE_URL || secrets.BACKEND_URL || 'https://sr-aibridge-backend.onrender.com' }}"
          curl -X POST "$BRIDGE_URL/api/diagnostics" \
            -H "Content-Type: application/json" \
            -d '{
              "type": "DEPLOYMENT_SUCCESS",
              "status": "success",
              "source": "GitHubAction",
              "meta": {
                "environment": "production",
                "timestamp": "'"$(date -u +"%Y-%m-%dT%H:%M:%SZ")"'"
              }
            }' || echo "Diagnostics notification failed (non-critical)"

  # Backend deployment to Render (webhook-based)
  deploy-backend:
    name: Trigger Backend Deployment
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate backend configuration
        run: |
          echo "Validating backend setup..."
          cd bridge_backend
          python3 -m py_compile main.py
          python3 -m py_compile self_test.py
          echo "✅ Backend Python files validated"

      - name: Notify Render Deployment Start
        run: |
          python3 bridge_backend/utils/deployment_publisher.py \
            --platform render \
            --event-type start \
            --status deploying \
            --branch main \
            --commit-sha ${{ github.sha }} \
            --message "Trigger Render deployment" || echo "⚠️ Event notification skipped"

      - name: Trigger Render deployment
        run: |
          if [ -n "${{ secrets.RENDER_DEPLOY_HOOK }}" ]; then
            echo "Triggering Render deployment..."
            curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK }}"
            echo "✅ Render deployment triggered"
          else
            echo "⚠️ RENDER_DEPLOY_HOOK not configured - skipping deployment"
            echo "Note: Render will auto-deploy on push to main branch"
          fi

      - name: Notify Render Deployment Success
        if: success()
        run: |
          python3 bridge_backend/utils/deployment_publisher.py \
            --platform render \
            --event-type success \
            --status triggered \
            --branch main \
            --commit-sha ${{ github.sha }} \
            --deploy-url "https://sr-aibridge.onrender.com" \
            --message "Render deployment triggered successfully" || echo "⚠️ Event notification skipped"

      - name: Notify Render Deployment Failure
        if: failure()
        run: |
          python3 bridge_backend/utils/deployment_publisher.py \
            --platform render \
            --event-type failure \
            --status failed \
            --branch main \
            --commit-sha ${{ github.sha }} \
            --message "Failed to trigger Render deployment" || echo "⚠️ Event notification skipped"

  # Build verification job
  verify-build:
    name: Verify Complete Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Notify GitHub Build Start
        run: |
          python3 bridge_backend/utils/deployment_publisher.py \
            --platform github \
            --event-type start \
            --status verifying \
            --branch ${{ github.ref_name }} \
            --commit-sha ${{ github.sha }} \
            --message "Build verification started" || echo "⚠️ Event notification skipped"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: bridge-frontend/package-lock.json

      - name: Install Chrome Dependencies
        run: |
          # Use GitHub's built-in browser tools
          npx playwright install-deps
          npx playwright install chromium

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install frontend dependencies
        run: cd bridge-frontend && npm ci

      - name: Install backend dependencies
        run: cd bridge_backend && pip install -r requirements.txt

      - name: Test frontend build
        run: cd bridge-frontend && npm run build
        env:
          CI: false

      - name: Test backend syntax
        run: |
          cd bridge_backend
          python3 -m py_compile main.py
          python3 -m py_compile self_test.py
          python3 -c "import main; print('✅ Backend imports successfully')"

      - name: Verify self-test script
        run: |
          cd bridge_backend
          python3 self_test.py --help
          echo "✅ Self-test script is executable"

      - name: Notify GitHub Build Success
        if: success()
        run: |
          python3 bridge_backend/utils/deployment_publisher.py \
            --platform github \
            --event-type success \
            --status verified \
            --branch ${{ github.ref_name }} \
            --commit-sha ${{ github.sha }} \
            --message "Build verification completed successfully" || echo "⚠️ Event notification skipped"

      - name: Notify GitHub Build Failure
        if: failure()
        run: |
          python3 bridge_backend/utils/deployment_publisher.py \
            --platform github \
            --event-type failure \
            --status failed \
            --branch ${{ github.ref_name }} \
            --commit-sha ${{ github.sha }} \
            --message "Build verification failed" || echo "⚠️ Event notification skipped"
