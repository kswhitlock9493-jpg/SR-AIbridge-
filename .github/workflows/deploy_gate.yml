name: Deploy Gate
on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
jobs:
  gate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with: { name: federation_repair_report, path: _artifacts/fed }
      - uses: actions/download-artifact@v4
        with: { name: build_triage_report, path: _artifacts/build }
      - uses: actions/download-artifact@v4
        with: { name: runtime_triage_report, path: _artifacts/runtime }
      - name: Evaluate
        run: |
          python3 - <<'PY'
          import json, sys, pathlib
          def rd(p): 
            try: return json.loads(pathlib.Path(p).read_text())
            except: return {}
          fed = rd("_artifacts/fed/bridge_backend/diagnostics/federation_repair_report.json")
          bld = rd("_artifacts/build/bridge_backend/diagnostics/build_triage_report.json")
          run = rd("_artifacts/runtime/bridge_backend/diagnostics/runtime_triage_report.json")
          ok_fed = fed.get("health") and all(v=="PASS" for v in fed["health"].values())
          ok_bld = bld.get("has_dist", False)
          ok_run = run.get("dns_ok") and run.get("health")==200 and run.get("db_ping")==200
          print("fed=",ok_fed,"build=",ok_bld,"runtime=",ok_run)
          sys.exit(0 if (ok_fed and ok_bld and ok_run) else 2)
          PY
