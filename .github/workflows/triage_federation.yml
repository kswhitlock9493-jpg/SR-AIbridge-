name: Triage Federation Heartbeat

on:
  push:
    branches: [ "main" ]
  pull_request:
  schedule:
    - cron: "*/30 * * * *"   # every 30 min
  workflow_dispatch:

jobs:
  triage:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -q httpx python-dateutil || true

      - name: Prepare paths
        run: |
          echo "DIAG=bridge_backend/diagnostics" >> $GITHUB_ENV
          mkdir -p bridge_backend/tools/triage/common
          mkdir -p bridge_backend/diagnostics

      - name: API Triage (auto-heal)
        env:
          PUBLIC_API_BASE: ${{ secrets.BACKEND_URL || 'https://sr-aibridge.onrender.com' }}
          TRIAGE_MAX_RETRIES: 4
          TRIAGE_TIMEOUT_MS: 8000
          TRIAGE_BACKOFF_BASE: 0.8
          TRIAGE_BACKOFF_FACTOR: 2.0
          TRIAGE_JITTER_MAX: 0.35
          TRIAGE_CIRCUIT_BREAKER_FAILS: 6
        run: |
          python3 bridge_backend/tools/triage/api_triage.py || true

      - name: Generate Parity Report (for endpoint triage)
        run: |
          python3 bridge_backend/tools/parity_engine.py || true

      - name: Endpoint Triage (parity-aware)
        env:
          PUBLIC_API_BASE: ${{ secrets.BACKEND_URL || 'https://sr-aibridge.onrender.com' }}
          ENDPOINT_TRIAGE_LIMIT: 20
          TRIAGE_MAX_RETRIES: 4
          TRIAGE_TIMEOUT_MS: 8000
          TRIAGE_BACKOFF_BASE: 0.8
          TRIAGE_BACKOFF_FACTOR: 2.0
          TRIAGE_JITTER_MAX: 0.35
          TRIAGE_CIRCUIT_BREAKER_FAILS: 6
        run: |
          python3 bridge_backend/tools/triage/endpoint_triage.py || true

      - name: Diagnostics Federation (heartbeat & guard)
        env:
          FEDERATION_MAX_WAIT_S: 120
        run: |
          python3 bridge_backend/tools/triage/diagnostics_federate.py || true

      - name: Upload Triage Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: triage-federation-reports
          path: ${{ env.DIAG }}/*.json

      - name: Determine Outcome
        id: gate
        run: |
          python - <<'PY'
          import json, pathlib
          p = pathlib.Path("bridge_backend/diagnostics/triage_federation_report.json")
          ok = False
          if p.exists():
            ok = json.loads(p.read_text()).get("ok", False)
          print(f"::set-output name=ok::{str(ok).lower()}")
          PY

      - name: Fail if federation failed after auto-heal
        if: steps.gate.outputs.ok == 'false' && (github.ref == 'refs/heads/main' || github.event_name == 'schedule')
        run: |
          echo "❌ Federation triage failed after retries. See artifacts."
          exit 1
      
      - name: Warn if federation degraded on PR
        if: steps.gate.outputs.ok == 'false' && github.event_name == 'pull_request'
        run: |
          echo "⚠️  Federation triage degraded (non-critical for PR context)"
          echo "This is expected for PRs where backend services may not be fully deployed."
