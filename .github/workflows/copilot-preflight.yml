name: Copilot PreFlight Environment Setup
on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:

jobs:
  preflight:
    name: Prepare Copilot Environment
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write
      security-events: write

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Configure Base Environment
        run: |
          echo "ğŸ”§ Configuring base environment..."
          sudo apt-get update -y
          sudo apt-get install -y dnsutils curl python3 python3-pip

      - name: Install Python Dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip install requests toml rich

      - name: Install Node Dependencies
        run: |
          cd bridge-frontend && (npm ci || npm install)

      - name: Pre-Firewall Environment Variables
        run: |
          echo "ğŸ”¥ Setting Copilot pre-firewall variables..."
          echo "BRIDGE_URL=${{ secrets.BRIDGE_URL }}" >> $GITHUB_ENV
          echo "NETLIFY_SITE_ID=${{ secrets.NETLIFY_SITE_ID }}" >> $GITHUB_ENV
          echo "NETLIFY_AUTH_TOKEN=${{ secrets.NETLIFY_AUTH_TOKEN }}" >> $GITHUB_ENV
          echo "NODE_ENV=production" >> $GITHUB_ENV
          echo "PYTHONPATH=$(pwd)" >> $GITHUB_ENV

      - name: Add Custom Firewall Allowlist
        run: |
          echo "ğŸŒ Configuring temporary allowlist..."
          mkdir -p .github/allowlist
          echo "example.com" >> .github/allowlist/hosts.txt
          echo "api.netlify.com" >> .github/allowlist/hosts.txt
          echo "bridge.sr-aibridge.com" >> .github/allowlist/hosts.txt
          echo "diagnostics.sr-aibridge.com" >> .github/allowlist/hosts.txt
          echo "render.com" >> .github/allowlist/hosts.txt
          echo "pypi.org" >> .github/allowlist/hosts.txt
          echo "registry.npmjs.org" >> .github/allowlist/hosts.txt
          echo "âœ… Added default allowlist hosts."

      - name: Preflight Sanity Check
        run: |
          echo "ğŸš€ Running DeepScan preflight..."
          python3 bridge_backend/scripts/deepscan_reporter.py || echo "âš ï¸ DeepScan preflight skipped (safe mode)"
          echo "âœ… Preflight sequence complete."
