name: ðŸ§ª Bridge Quality Gate
on:
  pull_request:
  push:
    branches: [ main, develop ]
    paths-ignore: 
      - "**/dist/**"
      - "**/*.md"
      - "docs/**"

jobs:
  bcse:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      pull-requests: write
    env:
      FORGE_DOMINION_ROOT: ${{ secrets.FORGE_DOMINION_ROOT }}
      DOMINION_SEAL: ${{ secrets.DOMINION_SEAL }}
      # Branch-aware policy URL - BCSE will use local policy if this is not set
      # FORGE_POLICY_URL: https://sovereign.bridge/api/forge/policy/quality?branch=${{ github.ref_name }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install production dependencies
        run: |
          pip install -r requirements.txt

      - name: Install dev dependencies
        run: |
          pip install -r requirements-dev.txt
          npm --prefix bridge-frontend ci

      - name: Run BCSE (Sovereign Quality Gate)
        id: bcse
        run: |
          python -m bridge_tools.bcse.cli analyze
        continue-on-error: true

      - name: Upload SARIF (if present)
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: bcse.sarif
        if: always() && hashFiles('bcse.sarif') != ''

      - name: Post PR summary
        if: always() && github.event_name == 'pull_request' && hashFiles('bcse_summary.md') != ''
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body-file bcse_summary.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Fail if quality gate failed
        if: steps.bcse.outcome != 'success'
        run: exit 1
