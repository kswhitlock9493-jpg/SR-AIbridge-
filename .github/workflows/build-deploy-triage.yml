name: üîÅ Build & Deploy Triage (DISABLED - Use deploy.yml)

on:
  # Disabled to prevent duplicate Netlify deployments
  # push:
  #   branches: [ main ]
  # pull_request:
  #   branches: [ main ]
  workflow_dispatch:

jobs:
  triage:
    name: Validate ‚Üí Build ‚Üí Deploy ‚Üí Notify
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Chrome Dependencies
        run: |
          # Install Playwright browser dependencies
          npx playwright install-deps
          npx playwright install chromium

      - run: pip install requests python-dotenv

      - name: üîç Validate & Auto-Heal Env
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
          BRIDGE_URL: ${{ secrets.BRIDGE_URL }}
        run: |
          python3 scripts/check_env_parity.py || (
            python3 scripts/repair_netlify_env.py
            python3 scripts/check_env_parity.py
            python3 scripts/report_bridge_event.py
          )

      - name: üß± Build Frontend
        env:
          BRIDGE_URL: ${{ secrets.BRIDGE_URL }}
          BRIDGE_SLACK_WEBHOOK: ${{ secrets.BRIDGE_SLACK_WEBHOOK }}
        run: |
          cd bridge-frontend
          npm ci
          npm run build || (
            echo "‚ùå Build failed ‚Äî notifying Bridge"
            python3 ../scripts/report_bridge_event.py report_build_failure || true
            exit 1
          )
          echo "‚úÖ Build succeeded ‚Äî notifying Bridge"
          python3 ../scripts/report_bridge_event.py report_build_success

      - name: üöÄ Deploy to Netlify
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
          BRIDGE_URL: ${{ secrets.BRIDGE_URL }}
          BRIDGE_SLACK_WEBHOOK: ${{ secrets.BRIDGE_SLACK_WEBHOOK }}
        run: |
          npm install -g netlify-cli
          echo "üöÄ Starting deployment..."
          netlify deploy --dir=bridge-frontend/dist --site=$NETLIFY_SITE_ID --prod || (
            echo "‚ö†Ô∏è Deploy failed ‚Äî rolling back to previous successful version"
            python3 scripts/report_bridge_event.py report_deploy_failure || true
            python3 scripts/netlify_rollback.py
            exit 1
          )

      - name: üì° Notify Bridge of Deploy Success
        if: success()
        env:
          BRIDGE_URL: ${{ secrets.BRIDGE_URL }}
        run: python3 -c "from scripts.report_bridge_event import report_deploy_success; report_deploy_success()"

      - name: üìä Generate CI/CD Triage Report
        if: always()
        working-directory: bridge_backend
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            python3 scripts/ci_cd_triage.py DEPLOYMENT_SUCCESS success
          else
            python3 scripts/ci_cd_triage.py DEPLOYMENT_FAILURE failed
          fi
      
      - name: üì§ Upload CI/CD Triage Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-cd-triage-report
          path: bridge_backend/ci_cd_report.json
          retention-days: 30

