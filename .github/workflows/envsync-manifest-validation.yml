name: EnvSync Manifest Validation

on:
  pull_request:
    paths:
      - 'bridge_backend/.genesis/envsync_seed_manifest.env'
      - 'scripts/validate_envsync_manifest.py'
  push:
    branches:
      - main
    paths:
      - 'bridge_backend/.genesis/envsync_seed_manifest.env'

jobs:
  validate-manifest:
    name: Validate EnvSync Seed Manifest
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Validate EnvSync Seed Manifest
        run: |
          echo "ğŸ” Validating EnvSync Seed Manifest..."
          python3 scripts/validate_envsync_manifest.py
      
      - name: Check variable count
        run: |
          echo "ğŸ“Š Analyzing manifest contents..."
          var_count=$(grep -E '^[A-Z_]+=.+' bridge_backend/.genesis/envsync_seed_manifest.env | wc -l)
          echo "âœ… Found $var_count variables in manifest"
          
          # Ensure we have at least the core variables
          if [ "$var_count" -lt 20 ]; then
            echo "âŒ ERROR: Expected at least 20 variables, found $var_count"
            exit 1
          fi
      
      - name: Check for secrets in manifest
        run: |
          echo "ğŸ›¡ï¸ Checking for potential secrets..."
          
          # List of patterns that should NOT appear as values in the manifest
          # (they can appear in variable names, but values should be safe)
          suspicious_patterns=(
            'BEGIN.*PRIVATE KEY'
            'Bearer [A-Za-z0-9]'
            'password.*:'
            'api_key.*:.*[A-Za-z0-9]{32}'
          )
          
          found_suspicious=false
          
          for pattern in "${suspicious_patterns[@]}"; do
            if grep -E "$pattern" bridge_backend/.genesis/envsync_seed_manifest.env; then
              echo "âš ï¸  WARNING: Potentially sensitive pattern found: $pattern"
              found_suspicious=true
            fi
          done
          
          if [ "$found_suspicious" = true ]; then
            echo ""
            echo "âŒ ERROR: Manifest appears to contain secrets or sensitive data"
            echo "Please ensure the manifest only contains non-sensitive configuration"
            exit 1
          else
            echo "âœ… No obvious secrets detected"
          fi
      
      - name: Verify metadata headers
        run: |
          echo "ğŸ“‹ Verifying metadata headers..."
          
          required_headers=(
            "Version:"
            "Purpose:"
            "AutoPropagate:"
            "SyncTarget:"
          )
          
          missing_headers=()
          
          for header in "${required_headers[@]}"; do
            if ! grep -q "# $header" bridge_backend/.genesis/envsync_seed_manifest.env; then
              missing_headers+=("$header")
            fi
          done
          
          if [ ${#missing_headers[@]} -gt 0 ]; then
            echo "âŒ ERROR: Missing required metadata headers:"
            printf '  - %s\n' "${missing_headers[@]}"
            exit 1
          else
            echo "âœ… All required metadata headers present"
          fi
      
      - name: Summary
        if: success()
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… EnvSync Seed Manifest validation passed!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Manifest: bridge_backend/.genesis/envsync_seed_manifest.env"
          echo "Version: Genesis v2.0.1a"
          echo ""
          echo "The manifest is ready for deployment. Changes will be"
          echo "automatically synchronized to Render and Netlify when"
          echo "ENVSYNC_CANONICAL_SOURCE=file is set."
          echo ""
