name: Environment Sync Trigger

# Automatically triggers environment synchronization when environment.json changes
# Part of the Autonomous Environment Lattice (v1.9.6x)

on:
  push:
    branches:
      - main
    paths:
      - '.github/environment.json'
  
  # Allow manual triggering
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'Force sync even if no changes detected'
        required: false
        default: 'false'

permissions:
  contents: read

jobs:
  trigger-env-sync:
    name: Trigger Environment Sync
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
      
      - name: Setup Python 3.12
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      
      - name: Install Dependencies
        run: |
          pip install -r requirements.txt
      
      - name: Trigger Environment Sync
        env:
          GENESIS_MODE: enabled
          GENESIS_TRACE_LEVEL: 2
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸš€ Triggering environment synchronization..."
          python3 .github/scripts/github_envhook.py --trigger
          
          echo ""
          echo "ðŸ“Š Sync Events Published:"
          echo "  â€¢ envmirror.sync.start - Cross-platform sync initiated"
          echo "  â€¢ envduo.audit - Integrity audit triggered"
      
      - name: Verify Sync Logs
        if: always()
        run: |
          if [ -f logs/github_envhook_triggers.log ]; then
            echo "ðŸ“„ Trigger log created:"
            tail -n 20 logs/github_envhook_triggers.log | jq -r '.timestamp + " | " + .event'
          fi
      
      - name: Upload Trigger Logs
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: envhook-trigger-logs
          path: |
            logs/github_envhook_triggers.log
            logs/github_envhook_state.json
          retention-days: 30
      
      - name: Comment on Commit
        if: github.event_name == 'push'
        uses: actions/github-script@v6
        with:
          script: |
            const sha = context.sha;
            const message = `ðŸŒŒ **Autonomous Environment Sync Triggered**
            
            The environment configuration has been updated. The following actions were initiated:
            
            âœ… **EnvMirror Sync** - Synchronizing across GitHub, Render, and Netlify
            âœ… **EnvDuo Audit** - ARIE + EnvRecon integrity check
            
            The Bridge will autonomously:
            1. Sync variables across all platforms
            2. Audit for drift and integrity issues
            3. Apply automatic healing if needed
            4. Truth-certify all operations
            
            _Triggered by commit ${sha.substring(0, 7)}_
            `;
            
            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: sha,
              body: message
            });
