name: ğŸ” Environment Parity & Auto-Heal

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  check-env-parity:
    name: Validate & Auto-Heal Render â†” Netlify â†” .env.production
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§° Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: ğŸ“¦ Install Dependencies
        run: |
          pip install requests python-dotenv

      - name: ğŸ” Validate & Auto-Heal Environment Parity
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
          BRIDGE_URL: ${{ secrets.BRIDGE_URL }}
          NETLIFY_API_KEY: ${{ secrets.NETLIFY_API_KEY }}
        run: |
          echo "ğŸ” Checking parity between Netlify, Render, and .env.production..."
          python3 scripts/check_env_parity.py || (
            echo "âš ï¸ Parity check failed â€” initiating auto-repair..."
            python3 scripts/repair_netlify_env.py
            echo "ğŸ” Re-running parity check after repair..."
            python3 scripts/check_env_parity.py || exit 1
            echo "ğŸ“¡ Notifying Bridge of auto-heal event..."
            python3 scripts/report_bridge_event.py
          )
