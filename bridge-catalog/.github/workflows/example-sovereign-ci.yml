name: Example - Sovereign CI/CD

# This workflow demonstrates how to use the Forge Token Engine
# for zero-cost CI/CD through self-hosted runners and free-tier providers

on:
  push:
    branches: [main, develop]
  pull_request:
  workflow_dispatch:

jobs:
  # Route all jobs to self-hosted runner for zero cost
  analyze-and-route:
    name: Analyze Workflow Routing
    runs-on: ubuntu-latest  # This lightweight job can stay on GitHub
    
    outputs:
      optimal_runner: ${{ steps.routing.outputs.runner }}
      estimated_minutes: ${{ steps.routing.outputs.minutes }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Determine optimal routing
        id: routing
        run: |
          # Check if self-hosted runner is available
          if [ -f .github/self-hosted-runner.json ]; then
            echo "runner=self-hosted" >> $GITHUB_OUTPUT
          else
            echo "runner=ubuntu-latest" >> $GITHUB_OUTPUT
          fi
          echo "minutes=15" >> $GITHUB_OUTPUT
  
  # Backend tests - Use self-hosted for zero cost
  test-backend:
    name: Backend Tests (Self-Hosted)
    needs: analyze-and-route
    runs-on: ${{ needs.analyze-and-route.outputs.optimal_runner }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
      
      - name: Run backend tests
        run: |
          cd bridge_backend
          python -m pytest tests/ -v
      
      - name: Record usage (optional - for tracking)
        if: always()
        run: |
          if [ "${{ needs.analyze-and-route.outputs.optimal_runner }}" == "self-hosted" ]; then
            echo "‚úÖ Ran on self-hosted runner - Zero cost"
            echo "üìä Estimated savings: \$0.04 (5 minutes @ \$0.008/min)"
          else
            echo "üìä Used GitHub Actions: 5 minutes"
          fi
  
  # Frontend build - Can also run on self-hosted or Netlify
  build-frontend:
    name: Frontend Build (Self-Hosted)
    needs: analyze-and-route
    runs-on: ${{ needs.analyze-and-route.outputs.optimal_runner }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: bridge-frontend/package-lock.json
      
      - name: Install dependencies
        run: |
          cd bridge-frontend
          npm ci
      
      - name: Build
        run: |
          cd bridge-frontend
          npm run build
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: bridge-frontend/dist/
          retention-days: 7
      
      - name: Record usage
        if: always()
        run: |
          if [ "${{ needs.analyze-and-route.outputs.optimal_runner }}" == "self-hosted" ]; then
            echo "‚úÖ Build completed on self-hosted runner"
            echo "üìä Estimated savings: \$0.024 (3 minutes @ \$0.008/min)"
          fi
  
  # Deploy - Use appropriate provider based on target
  deploy-preview:
    name: Deploy Preview (Netlify Free Tier)
    needs: [test-backend, build-frontend]
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest  # Lightweight deploy job
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: bridge-frontend/dist/
      
      - name: Deploy to Netlify (Free Tier)
        uses: nwtgck/actions-netlify@v3.0
        with:
          publish-dir: bridge-frontend/dist
          production-deploy: false
          deploy-message: "Preview deploy for PR #${{ github.event.number }}"
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
      
      - name: Record usage
        run: |
          echo "üìä Netlify deploy used Netlify's free tier minutes"
          echo "‚úÖ No GitHub Actions minutes consumed for actual deploy"
  
  # Production deploy - Use Render free tier
  deploy-production:
    name: Deploy Production (Render Free Tier)
    needs: [test-backend, build-frontend]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest  # Lightweight trigger job
    
    steps:
      - name: Trigger Render Deploy
        run: |
          if [ -n "${{ secrets.RENDER_DEPLOY_HOOK }}" ]; then
            curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK }}"
            echo "‚úÖ Triggered Render deploy using free tier"
            echo "üìä Build happens on Render (free 750 hours/month)"
          else
            echo "‚ö†Ô∏è  RENDER_DEPLOY_HOOK not configured"
          fi
  
  # Cost tracking and reporting
  report-costs:
    name: Cost Report
    needs: [test-backend, build-frontend, deploy-preview, deploy-production]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: pip install pyyaml
      
      - name: Generate cost report
        run: |
          echo "========================================"
          echo "üí∞ WORKFLOW COST REPORT"
          echo "========================================"
          echo ""
          echo "Jobs executed:"
          echo "  - analyze-and-route: 1 min (GitHub)"
          echo "  - test-backend: 5 min (${{ needs.analyze-and-route.outputs.optimal_runner }})"
          echo "  - build-frontend: 3 min (${{ needs.analyze-and-route.outputs.optimal_runner }})"
          echo "  - deploy: 1 min (Netlify/Render free tier)"
          echo ""
          
          if [ "${{ needs.analyze-and-route.outputs.optimal_runner }}" == "self-hosted" ]; then
            echo "‚úÖ Total GitHub Actions cost: \$0.016 (2 lightweight jobs)"
            echo "‚úÖ Savings from self-hosted: \$0.064 (8 minutes avoided)"
            echo "üìä Total savings: 80% cost reduction"
          else
            echo "üìä Total GitHub Actions cost: \$0.080 (10 minutes)"
            echo "‚ÑπÔ∏è  Tip: Set up self-hosted runner for zero cost"
          fi
          echo ""
          echo "========================================"
      
      - name: Run cost analysis tools (if available)
        continue-on-error: true
        run: |
          if [ -f .github/forge_token_engine/cost_bypass.py ]; then
            python .github/forge_token_engine/cost_bypass.py --report || true
          fi

# This workflow demonstrates:
# 1. Routing heavy compute (tests, builds) to self-hosted runners
# 2. Using Netlify/Render free tiers for deploys
# 3. Keeping only lightweight orchestration on GitHub Actions
# 4. Tracking and reporting on cost savings
#
# Result: ~80% cost reduction through legitimate optimization
