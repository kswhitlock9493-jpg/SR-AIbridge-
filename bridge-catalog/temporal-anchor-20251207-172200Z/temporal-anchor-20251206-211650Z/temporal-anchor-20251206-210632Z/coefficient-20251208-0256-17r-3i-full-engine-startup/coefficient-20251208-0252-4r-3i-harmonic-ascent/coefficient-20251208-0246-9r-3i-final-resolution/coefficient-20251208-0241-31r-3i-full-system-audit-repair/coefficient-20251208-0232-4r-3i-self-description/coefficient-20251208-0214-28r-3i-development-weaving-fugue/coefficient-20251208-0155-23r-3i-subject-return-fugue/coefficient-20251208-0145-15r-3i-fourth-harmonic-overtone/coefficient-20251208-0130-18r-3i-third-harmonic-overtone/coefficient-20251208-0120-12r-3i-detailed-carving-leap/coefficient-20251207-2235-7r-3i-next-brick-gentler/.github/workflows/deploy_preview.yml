name: Deploy Preview (Bridge Preflight)

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: write
  actions: read

jobs:
  preflight:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (PR)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Chrome Dependencies
        run: |
          # Install system dependencies for Playwright only (skip browser downloads)
          npx playwright install-deps
        env:
          PUPPETEER_SKIP_DOWNLOAD: "true"
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: "true"
          PUPPETEER_SKIP_CHROMIUM_DOWNLOAD: "true"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install backend deps
        run: |
          python -m pip install -U pip
          pip install -r requirements.txt

      - name: Preflight (Chimera)
        run: |
          python - <<'PY'
          from pathlib import Path
          from bridge_backend.engines.chimera.core import ChimeraEngine
          import asyncio
          async def main():
              eng = ChimeraEngine(Path(".").resolve())
              await eng.preflight()
          asyncio.run(main())
          PY

      - name: Commit generated deploy artifacts if changed
        run: |
          set -e
          git config user.name "bridge-bot"
          git config user.email "bridge-bot@users.noreply.github.com"
          git add _headers _redirects netlify.toml || true
          if ! git diff --cached --quiet; then
            git commit -m "chore(preflight): update deploy artifacts"
            git push
          fi

      - name: Upload preflight artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bridge-preflight
          path: |
            _headers
            _redirects
            netlify.toml

  netlify-preview:
    needs: preflight
    runs-on: ubuntu-latest
    steps:
      - name: Netlify (defer to integration)
        run: echo "Netlify will pick up the PR with validated artifacts."
