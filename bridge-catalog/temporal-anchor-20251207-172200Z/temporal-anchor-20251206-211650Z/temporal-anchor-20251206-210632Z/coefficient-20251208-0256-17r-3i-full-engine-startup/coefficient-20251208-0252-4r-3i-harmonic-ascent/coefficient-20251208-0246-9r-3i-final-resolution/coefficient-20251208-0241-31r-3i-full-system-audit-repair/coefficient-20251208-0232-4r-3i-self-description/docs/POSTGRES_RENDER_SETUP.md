# Render PostgreSQL Setup

This guide covers the setup and configuration of PostgreSQL on Render for the SR-AIbridge backend.

## 1. Database

The SR-AIbridge backend uses PostgreSQL for production deployments on Render.

### Database Details
- **Created via**: Render Dashboard
- **Region**: Oregon (US West)
- **Version**: PostgreSQL 15
- **Database Name**: `sr_aibridge_main`
- **Admin User**: `sr_admin`

### Creating the Database

1. Log in to [Render Dashboard](https://dashboard.render.com)
2. Click **New** → **PostgreSQL**
3. Configure:
   - **Name**: `sr-aibridge-db`
   - **Database**: `sr_aibridge_main`
   - **User**: `sr_admin`
   - **Region**: Oregon (US West)
   - **Plan**: Choose based on your needs (Pro recommended for production)
4. Click **Create Database**
5. Wait for the database to be provisioned

## 2. Connection

Use the **Internal Database URL** for backend services running on Render.

### Connection String Format

```
postgresql://sr_admin:<PASSWORD>@dpg-d3i3jc0dl3ps73csp9e0-a/sr_aibridge_main
```

**Note**: The internal hostname includes the region suffix:
```
postgresql://sr_admin:<PASSWORD>@dpg-d3i3jc0dl3ps73csp9e0-a.oregon-postgres.render.com/sr_aibridge_main
```

### Important Notes

- Always use the **Internal Database URL** for services running on Render (better performance, lower latency)
- Use the **External Database URL** only for connections from outside Render (local development, external tools)
- The password is automatically generated by Render and can be found in the database's **Info** tab
- For async operations (FastAPI), use `postgresql+asyncpg://` instead of `postgresql://`

## 3. Render Environment

Configure your backend service environment variables in Render:

1. Go to your web service in Render Dashboard
2. Navigate to the **Environment** tab
3. Add or update the following variables:

### Required Environment Variables

```bash
# Database Configuration
DATABASE_TYPE=postgres
DATABASE_URL=postgresql://sr_admin:<PASSWORD>@dpg-d3i3jc0dl3ps73csp9e0-a.oregon-postgres.render.com/sr_aibridge_main

# Bridge Services
VAULT_URL=https://bridge.netlify.app/api/vault
CASCADE_MODE=production
FEDERATION_SYNC_KEY=<YOUR_GENERATED_SECRET>

# Optional Monitoring
DATADOG_API_KEY=
DATADOG_REGION=us
```

### Environment Variable Details

- **DATABASE_URL**: Use the Internal Database URL from Render
  - For async operations, the backend automatically converts `postgresql://` to `postgresql+asyncpg://`
  - You can also set it directly with `postgresql+asyncpg://` if preferred

- **VAULT_URL**: API endpoint for vault operations
  - Default: `https://bridge.netlify.app/api/vault`

- **CASCADE_MODE**: Controls bridge operation mode
  - Options: `development`, `production`
  - Use `production` for deployed services

- **FEDERATION_SYNC_KEY**: Secure key for federation synchronization
  - Generate a strong random key (at least 32 characters)
  - Keep this secret and never commit it to version control

- **DATADOG_API_KEY**: Optional Datadog API key for monitoring
- **DATADOG_REGION**: Datadog region (default: `us`)

## 4. Verification

After deploying your backend service with the updated environment variables:

1. Open your Render service's **Logs** tab
2. Look for the database connection verification message:

```
✅ Database connection verified.
```

If you see this message, the backend is successfully connected to PostgreSQL.

### Troubleshooting Connection Issues

If you see an error message instead:

```
❌ Database connection failed: <error details>
```

Check the following:

1. **Verify DATABASE_URL**: Ensure the connection string is correct
   - Check username, password, hostname, and database name
   - Ensure you're using the Internal Database URL for Render services

2. **Check Database Status**: Verify the database is running
   - Go to your database in Render Dashboard
   - Ensure it's not paused or suspended

3. **Verify Network Access**: Ensure the database accepts connections from your web service
   - Render automatically configures network access for services in the same region
   - No additional firewall rules needed for internal connections

4. **Check Logs**: Review full error details in the service logs
   - Connection timeouts may indicate network issues
   - Authentication errors indicate incorrect credentials

## 5. Database Initialization

After connecting to PostgreSQL, initialize the database schema:

### Option A: Via Render Shell

1. Open your database in Render Dashboard
2. Click the **Shell** tab
3. Copy and paste the contents of `init.sql` from the repository
4. Press Enter to execute

### Option B: From Local Machine

```bash
# Using the External Database URL
psql "postgresql://sr_admin:<PASSWORD>@dpg-d3i3jc0dl3ps73csp9e0-a.oregon-postgres.render.com/sr_aibridge_main" \
  -v ON_ERROR_STOP=1 \
  -f init.sql
```

### What Gets Created

The `init.sql` script creates:
- Database schema (`sra`)
- Required tables (missions, agents, vault_logs, guardians, etc.)
- Indexes for performance
- Partitions for time-based data (if using PostgreSQL-specific features)

## 6. Monthly Maintenance

PostgreSQL databases benefit from regular maintenance:

### Automated Maintenance

Set up a scheduled job in Render:

1. Create a new **Cron Job** in Render Dashboard
2. Configure:
   - **Command**: `psql "$DATABASE_URL" -f maintenance.sql`
   - **Schedule**: `0 0 1 * *` (monthly, first day of month)
3. Save and enable

### Manual Maintenance

Run the maintenance script manually:

```bash
psql "$DATABASE_URL" -f maintenance.sql
```

The maintenance script:
- Creates new partitions for time-series data
- Drops old partitions (older than retention period)
- Reindexes tables
- Runs VACUUM to reclaim space

## 7. Security Best Practices

- ✅ **Never commit credentials**: Keep `.env` files out of version control
- ✅ **Use environment variables**: Store all secrets in Render's Environment tab
- ✅ **Rotate passwords regularly**: Update database password every 90 days
- ✅ **Use Internal URLs**: Always use internal database URLs for Render services
- ✅ **Enable SSL/TLS**: Render PostgreSQL uses SSL by default
- ✅ **Limit access**: Only grant necessary permissions to application users
- ✅ **Monitor connections**: Watch for unusual connection patterns

## 8. Performance Optimization

### Connection Pooling

The backend uses SQLAlchemy's async connection pooling:

```python
# Default settings in bridge_backend/db.py
engine_kwargs = {
    "pool_pre_ping": True,     # Verify connections before use
    "pool_recycle": 300,       # Recycle connections after 5 minutes
    "echo": False              # Disable SQL query logging
}
```

For high-traffic deployments, you can tune these settings.

### Monitoring Queries

Enable PostgreSQL extensions for query monitoring:

```sql
-- Enable pg_stat_statements (one-time setup)
CREATE EXTENSION IF NOT EXISTS pg_stat_statements;

-- View slow queries
SELECT 
  mean_exec_time,
  calls,
  query
FROM pg_stat_statements
WHERE mean_exec_time > 100  -- queries taking > 100ms
ORDER BY mean_exec_time DESC
LIMIT 20;
```

## 9. Backup and Recovery

Render provides automated backups for PostgreSQL databases:

- **Automatic Backups**: Daily backups retained for 7 days (Pro plan)
- **Manual Backups**: Create on-demand backups before major changes
- **Point-in-Time Recovery**: Available on some plans

### Creating a Manual Backup

1. Go to your database in Render Dashboard
2. Click **Backups** tab
3. Click **Create Backup**
4. Wait for backup to complete

### Restoring from Backup

1. Go to **Backups** tab
2. Find the backup you want to restore
3. Click **Restore** (this creates a new database)
4. Update your service's `DATABASE_URL` to point to the restored database

## 10. Migration from SQLite

If migrating from SQLite to PostgreSQL:

1. **Export SQLite data**:
   ```bash
   sqlite3 bridge.db .dump > sqlite_dump.sql
   ```

2. **Convert SQLite dump to PostgreSQL**:
   - Use a conversion tool like `pgloader`
   - Or manually edit the dump file to fix syntax differences

3. **Import to PostgreSQL**:
   ```bash
   psql "$DATABASE_URL" -f converted_dump.sql
   ```

4. **Verify data integrity**:
   - Check row counts match
   - Verify foreign key relationships
   - Test application functionality

## Support

For issues or questions:
- Check the [POSTGRES_MIGRATION.md](../POSTGRES_MIGRATION.md) for detailed migration guide
- Review [README.md](../README.md) troubleshooting section
- Review [DEPLOYMENT.md](../DEPLOYMENT.md) for Render-specific guidance
- Open an issue on GitHub

---

**SR-AIbridge Render PostgreSQL Setup Guide v1.0**
