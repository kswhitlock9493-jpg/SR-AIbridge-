# ==============================================================
# ðŸŒ‰ Sovereign Bridge â€” Dynamic Quality Policy Profile
# Pulled by the BCSE via Forge Dominion handshake.
# ==============================================================

version: 5.5.3
seal: "${DOMINION_SEAL}"        # validated by Forge if present
epoch: "auto"

# ==============================================================
# Default Quality Gates
# ==============================================================
defaults:
  coverage_min: 0.80            # minimum coverage to pass CI
  mypy_strict: true             # enforce full type checks
  ruff_severity: "E,W,F"        # treat errors + warnings + formatting as violations
  bandit_min_severity: "MEDIUM" # require no â‰¥ medium severity vulns
  max_cyclomatic: 10            # max acceptable code complexity
  fail_on_vuln: true            # dependency security must pass
  allowed_licenses:
    - MIT
    - BSD-3-Clause
    - Apache-2.0
    - ISC
    - Python-2.0
  js:
    audit_level: "high"         # npm audit --audit-level
  paths:
    include: 
      - "bridge_backend"
      - "bridge_tools"
      - "codex"
      - "scripts"
      - "bridge-frontend"
    exclude: 
      - "**/node_modules/**"
      - "**/.venv/**"
      - "dist/**"
      - "build/**"
      - "codex/output/**"
  tests:
    markers_optional: []
  contracts:
    import_linter: true

# ==============================================================
# Environment Tier Overrides
# ==============================================================
env:
  development:
    coverage_min: 0.65       # allow flexibility during active development
    mypy_strict: false       # typing is advisory only
    max_cyclomatic: 14       # allow exploration & refactoring
    fail_on_vuln: false      # warn only
    js:
      audit_level: "moderate"

  staging:
    coverage_min: 0.75
    mypy_strict: true
    max_cyclomatic: 12
    fail_on_vuln: true
    js:
      audit_level: "high"

  production:
    coverage_min: 0.90       # strong correctness requirement
    mypy_strict: true
    max_cyclomatic: 8
    bandit_min_severity: "LOW"
    fail_on_vuln: true       # absolute enforcement
    js:
      audit_level: "critical"

# ==============================================================
# ðŸ”± Sovereign Branch Rules
# (BCSE will auto-select these depending on branch name)
# ==============================================================
branches:
  main:
    coverage_min: 0.85
    mypy_strict: true
    ruff_severity: "E,W,F,I"        # include import rules on main
    bandit_min_severity: "MEDIUM"
    max_cyclomatic: 10
    fail_on_vuln: true
    js:
      audit_level: "high"
    contracts:
      import_linter: true

  "release/*":
    coverage_min: 0.88
    mypy_strict: true
    ruff_severity: "E,W,F,I"   # include import rules on releases
    bandit_min_severity: "HIGH"
    max_cyclomatic: 8
    fail_on_vuln: true
    js:
      audit_level: "critical"
    contracts:
      import_linter: true

  "hotfix/*":
    coverage_min: 0.75
    mypy_strict: true
    max_cyclomatic: 12
    fail_on_vuln: true
    js:
      audit_level: "moderate"
    contracts:
      import_linter: true

  "feature/*":
    coverage_min: 0.70
    mypy_strict: false          # allow exploration
    max_cyclomatic: 12
    fail_on_vuln: false         # surface but don't fail features
    ruff_severity: "E,W,F"
    js:
      audit_level: "moderate"
    contracts:
      import_linter: false

  develop:
    coverage_min: 0.80
    mypy_strict: true
    ruff_severity: "E,W,F"
    max_cyclomatic: 12
    fail_on_vuln: true
    js:
      audit_level: "high"
    contracts:
      import_linter: true

  "staging/*":
    coverage_min: 0.75
    mypy_strict: true
    ruff_severity: "E,W,F"
    max_cyclomatic: 12
    fail_on_vuln: true
    js:
      audit_level: "high"
    contracts:
      import_linter: true

# ==============================================================
# ðŸ§¬ Federation Role Behavior
# (Leadership-aware enforcement â€” fits your BRH Consensus Runtime)
# ==============================================================
federation:
  leader:
    coverage_min: "+0.05"   # leader nodes enforce harsher coverage
    max_cyclomatic: "-1"     # stricter complexity limits
  witness:
    coverage_min: "-0.05"   # witness nodes accept slightly lower
    max_cyclomatic: "+2"     # more lenient complexity

# ==============================================================
# Path-Specific Overrides
# (Tighten security for sensitive directories)
# ==============================================================
overrides:
  # Stricter rules for core engines
  - when_paths: 
      - "bridge_backend/bridge_core/engines/**"
    set:
      bandit_min_severity: "HIGH"
      max_cyclomatic: 8
      mypy_strict: true

  # Enhanced linting for codex
  - when_paths: 
      - "codex/**"
    set:
      ruff_severity: "E,W,F,I,B"  # include bugbear-like rules if configured
      max_cyclomatic: 10

  # Security-critical paths
  - when_paths:
      - "bridge_backend/bridge_core/security/**"
      - "bridge_backend/bridge_core/auth/**"
    set:
      bandit_min_severity: "HIGH"
      mypy_strict: true
      max_cyclomatic: 6

# ==============================================================
# License Policy
# ==============================================================
licenses:
  allow: 
    - MIT
    - BSD-3-Clause
    - Apache-2.0
    - ISC
    - Python-2.0
  deny: 
    - GPL-3.0
    - AGPL-3.0
    - LGPL-3.0    # adjust to your policy

# ==============================================================
# Engine Toggles
# ==============================================================
engines:
  python_linters: true
  structure_contracts: true
  security_static: true
  deps_audit: true
  tests_coverage: true
